name: Test

on:
  push:
    branches: [test/riscv32]
  workflow_dispatch:
    inputs:
      ref:
        default: master
        description: blst version
        required: false
      publish:
        default: false
        description: Publish package
        required: false
        type: boolean

env:
  RETENTION: 2

jobs:
  build-linux:
    name: Linux build
    strategy:
      matrix:
        arch: [riscv32]
    runs-on: ubuntu-latest
    steps:
      - name: Check out blst repository
        uses: actions/checkout@v4
        with:
          repository: supranational/blst
          ref: v0.3.12
          path: blst

      - name: Set up GNU C compiler for arm64
        # if: matrix.arch == 'arm64'
        run: |
          curl -sL https://github.com/riscv-collab/riscv-gnu-toolchain/releases/download/2024.11.22/riscv32-glibc-ubuntu-22.04-gcc-nightly-2024.11.22-nightly.tar.xz -o riscv32.tar.xz
          mkdir -p /opt/riscv32
          tar xf riscv32.tar.xz -C /opt/riscv32/
          chmod -R +x /opt/riscv32/riscv
          #sudo chmod -R u+w /opt/riscv32/riscv/riscv32-unknown-linux-gnu
          ls -l /opt/riscv32/riscv/riscv32-unknown-linux-gnu


      - name: Build
        working-directory: blst
        run: |
          export PATH=/opt/riscv32/riscv/bin:$PATH
          ./build.sh CC=/opt/riscv32/riscv/bin/riscv32-unknown-linux-gnu-gcc -shared

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}
          path: blst/libblst.so
          retention-days: ${{ env.RETENTION }}
          if-no-files-found: error
